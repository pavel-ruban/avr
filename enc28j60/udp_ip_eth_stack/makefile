#############################################################
#######  MCU Atemga48 make scripts by Pavel Ruban  ##########
#############################################################

include makefile.conf

SRC =	main.c \
	lan.c \
	enc28j60.c \
	avr.s

CFILES = $(filter %.c, $(SRC))
SFILES = $(filter %.s, $(SRC))

COBJ = $(CFILES:.c=.o)
SOBJ = $(SFILES:.s=.o)
COBJD = $(COBJ:.o=.d)

all: $(TARGET_BINARY)

# Make c dependencies.
$(COBJD): %.d: %.c
	$(GCC) -MM $< > $@

# Include autogenerated dependencies.
-include $(COBJD)

$(COBJ): %.o: %.c
	$(GCC) -mmcu=$(MMCU) $(CFLAGS) $(CINCLUDES) $< -c -o $@

$(SOBJ): %.o: %.s
	$(AS) -m $(MMCU) $(SFLAGS) $(SINCLUDES) $< -c -o $@

# Translate & link binary file
$(TARGET_BINARY): $(COBJD) $(COBJ) $(SOBJ)
	$(LD) $(SOBJ) $(COBJ) -T ld.cls -o $(TARGET_BINARY) $(LINKFLAGS)

flash: $(TARGET_BINARY)
	avrdude -Pusb -cusbasp -p$(FMMCU) -U flash:w:$(TARGET_BINARY) -s

.PHONY:	clean

clean:
	rm *.{o,d,bin}
